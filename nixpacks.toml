# Railway Nixpacks Configuration for Symfony 6 + Webpack Encore
# PHP 8.4 avec extensions nÃ©cessaires pour MySQL, Intl, Zip
# Node.js 20 et Yarn pour Webpack Encore

# ðŸ”§ PHP et Node.js comme providers principaux
providers = ["php", "nodejs"]

[phases.setup]
nixPkgs = [
    "php84",
    "php84Extensions.pdo_mysql",
    "php84Extensions.intl",
    "php84Extensions.zip",
    "php84Extensions.opcache",
    "php84Extensions.apcu",
    "nodejs",
    "yarn"
]

[phases.build]
# ðŸ”§ Installer d'abord les dÃ©pendances PHP et Node
cmds = [
    # Composer install pour remplir vendor/
    "composer install --no-dev --optimize-autoloader --no-interaction",

    # Node.js / Yarn pour Webpack Encore
    "yarn install --frozen-lockfile",
    "yarn run build"
]

[phases.start]
# ðŸ”§ Nettoyer les caches et prÃ©parer le dÃ©marrage
cmds = [
    # Supprimer caches temporaires
    "rm -rf var/cache/*",

    # Clear cache Symfony (aprÃ¨s composer install)
    "php bin/console cache:clear --no-warmup --no-interaction"
]

[start]
# ðŸ”§ Commande de dÃ©marrage Railway
cmd = "php -S 0.0.0.0:${PORT:-8080} -t public"
